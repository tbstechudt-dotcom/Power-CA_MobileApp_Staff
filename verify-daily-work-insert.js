const { Pool } = require('pg');
require('dotenv').config();

const desktopPool = new Pool({
  host: process.env.LOCAL_DB_HOST || 'localhost',
  port: parseInt(process.env.LOCAL_DB_PORT || '5432'),
  database: process.env.LOCAL_DB_NAME || 'enterprise_db',
  user: process.env.LOCAL_DB_USER || 'postgres',
  password: process.env.LOCAL_DB_PASSWORD
});

async function verify() {
  console.log('Verifying inserted workdiary records...\n');

  try {
    // Check the newly inserted record (work_id = wd_id = 16)
    const result = await desktopPool.query(`
      SELECT dw_id, org_id, loc_id, work_dt, job_id, task_id,
             sporgid, work_man_min, year_id, work_det, work_id
      FROM daily_work
      WHERE work_id = 16
      ORDER BY dw_id DESC
      LIMIT 1
    `);

    if (result.rows.length > 0) {
      console.log('[SUCCESS] Found workdiary record in daily_work:');
      const record = result.rows[0];
      console.log(`  dw_id: ${record.dw_id} (auto-generated by trigger)`);
      console.log(`  org_id: ${record.org_id}, loc_id: ${record.loc_id}`);
      console.log(`  work_dt: ${new Date(record.work_dt).toDateString()}`);
      console.log(`  job_id: ${record.job_id}, task_id: ${record.task_id}`);
      console.log(`  staff_id (sporgid): ${record.sporgid}`);
      console.log(`  minutes: ${record.work_man_min}`);
      console.log(`  year_id: ${record.year_id} (fiscal year from work date)`);
      console.log(`  work_det: ${record.work_det}`);
      console.log(`  work_id: ${record.work_id} (= wd_id for reference)`);
    } else {
      console.log('[ERROR] Record not found!');
    }

    // Check if trigger created jc_weeklyplan record
    console.log('\nChecking jc_weeklyplan (created by trigger)...');
    const weeklyplan = await desktopPool.query(`
      SELECT week_id, week_no, job_id, sporg_id,
             mon_min, tue_min, wed_min, thu_min, fri_min, sat_min, sun_min
      FROM jc_weeklyplan
      WHERE job_id = 6260 AND sporg_id = 2
        AND week_start <= '2025-11-21' AND week_end >= '2025-11-21'
      LIMIT 1
    `);

    if (weeklyplan.rows.length > 0) {
      console.log('[SUCCESS] Trigger created/updated jc_weeklyplan record:');
      const wp = weeklyplan.rows[0];
      console.log(`  week_id: ${wp.week_id}, week_no: ${wp.week_no}`);
      console.log(`  job_id: ${wp.job_id}, staff_id: ${wp.sporg_id}`);
      console.log(`  Weekly minutes: Mon=${wp.mon_min}, Tue=${wp.tue_min}, Wed=${wp.wed_min}, Thu=${wp.thu_min}, Fri=${wp.fri_min}, Sat=${wp.sat_min}, Sun=${wp.sun_min}`);
    } else {
      console.log('[INFO] No jc_weeklyplan record found (may have been updated)');
    }

  } catch (error) {
    console.error('Error:', error.message);
  } finally {
    await desktopPool.end();
  }
}

verify();
