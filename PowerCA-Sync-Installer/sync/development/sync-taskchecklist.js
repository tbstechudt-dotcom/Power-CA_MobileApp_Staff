/**
 * Sync taskchecklist (skip tc_id - auto-increment)
 *
 * This syncs all 2,894 taskchecklist records
 * tc_id will be auto-generated by PostgreSQL sequence
 */

require('dotenv').config();
const { Pool } = require('pg');
const config = require('./config');

const localPool = new Pool(config.source);
const supabasePool = new Pool({
  ...config.target,
  ssl: { rejectUnauthorized: false }
});

async function syncTaskChecklist() {
  try {
    console.log('='.repeat(70));
    console.log('SYNCING TASKCHECKLIST (Auto-Increment tc_id)');
    console.log('='.repeat(70));

    // 1. Extract from source
    console.log('\n1. Extracting records from source...');
    const sourceData = await localPool.query(`SELECT * FROM taskchecklist`);
    console.log(`   ✓ Extracted ${sourceData.rows.length} records from source`);

    if (sourceData.rows.length === 0) {
      console.log('   ⚪ No records to sync\n');
      return { succeeded: 0, failed: 0 };
    }

    // 2. Clear target table (full replacement)
    console.log('\n2. Clearing target table...');
    await supabasePool.query(`DELETE FROM taskchecklist`);
    console.log(`   ✓ Cleared taskchecklist table`);

    // 3. Prepare insert (skip tc_id - let it auto-generate)
    console.log('\n3. Preparing insert...');
    const sampleRow = sourceData.rows[0];
    const skipColumns = ['tc_id']; // Skip tc_id - auto-increment
    const columns = Object.keys(sampleRow).filter(col => !skipColumns.includes(col));

    // Add sync columns if not present
    const syncColumns = ['source', 'created_at', 'updated_at'];
    const finalColumns = [...columns, ...syncColumns.filter(c => !columns.includes(c))];

    console.log(`   ✓ Columns to sync: ${finalColumns.length}`);
    console.log(`   ✓ Skipped columns: ${skipColumns.join(', ')}`);

    let succeeded = 0;
    let failed = 0;

    console.log('\n4. Inserting records...');
    for (const row of sourceData.rows) {
      const values = finalColumns.map(col => {
        if (col === 'source') return row[col] || 'D';
        if (col === 'created_at' || col === 'updated_at') return new Date();
        return row[col];
      });

      const placeholders = finalColumns.map((_, i) => `$${i + 1}`).join(', ');
      const insertQuery = `
        INSERT INTO taskchecklist (${finalColumns.join(', ')})
        VALUES (${placeholders})
      `;

      try {
        await supabasePool.query(insertQuery, values);
        succeeded++;
        if (succeeded % 500 === 0) {
          console.log(`   ⏳ Processed ${succeeded}/${sourceData.rows.length} records...`);
        }
      } catch (error) {
        failed++;
        if (failed <= 5) {
          console.log(`   ⚠️  Error: ${error.message}`);
        }
      }
    }

    console.log('\n' + '='.repeat(70));
    console.log('SYNC SUMMARY');
    console.log('='.repeat(70));
    console.log(`  Source records:    ${sourceData.rows.length}`);
    console.log(`  Successfully synced: ${succeeded}`);
    console.log(`  Failed:              ${failed}`);
    console.log('='.repeat(70));

    if (succeeded === sourceData.rows.length) {
      console.log('\n✓ All taskchecklist records synced successfully!');
    } else if (failed > 0) {
      console.log(`\n⚠️  ${failed} records failed to sync`);
    }

    console.log('\nNote: tc_id values are auto-generated by PostgreSQL sequence');
    console.log('='.repeat(70));

    return { succeeded, failed };

  } catch (error) {
    console.error('\n❌ Sync failed:', error.message);
    console.error('Stack:', error.stack);
    return { succeeded: 0, failed: 0 };
  }
}

async function main() {
  try {
    const result = await syncTaskChecklist();

    await localPool.end();
    await supabasePool.end();

    if (result.failed > 0) {
      process.exit(1);
    }

  } catch (error) {
    console.error('\n❌ Fatal error:', error.message);
    console.error('Stack:', error.stack);
    process.exit(1);
  }
}

main();
